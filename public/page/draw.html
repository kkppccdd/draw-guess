<!doctype html>
<html>
<head>
    <title>我画你猜</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
	<link rel="stylesheet" href="/lib/jquery.mobile/jquery.mobile-1.2.0.min.css" />
	<link rel="stylesheet" href="/lib/jquery.mobile.simpledialog.min.css" />
	<script src="/lib/jquery/jquery-1.8.2.min.js"></script>
	<script src="/lib/jquery.mobile/jquery.mobile-1.2.0.min.js"></script>
	<script src="/lib/jquery.mobile.simpledialog2.min.js" ></script>
	<script src="/lib/canvas-to-blob.min.js" ></script>
	<script src="/lib/s3upload.js" ></script>
    <style type="text/css">
	  body {
		margin:0px;
		width:100%;
		height:100%;
		overflow:hidden;
        /* prevent text selection on ui */
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        /* prevent scrolling in windows phone */
        -ms-touch-action: none;
	  }
	  #content {
          overflow:hidden;
		  background-color:#ddd;
	  }
	  #canvas{
		cursor:crosshair ;
        background-color:#fff;
	  }
	  .tool-case {
		width:260px;
		margin:auto;
		text-align:center;
	  }
	  .tool-box {
		float:left;
		padding:2px 6px 2px 6px;
	  }
	  .tool {
		border:2px solid #777;
		height:36px;
		width:36px;
	  }
	  .color-card{
	  	height:64px;
		width:64px;
		}
	  .red{
		background-color:#FF0000;
	  }
	  .blue{
		background-color:#0000FF;
	  }
	  .green{
		background-color:#00FF00;
	  }
	  .yellow{
	  	background-color:#FFFF00;
	  }
	  .aqua{
	  	background-color:#00FFFF;
	  }
	  .fuchsia{
	  	background-color:#FF00FF;
	  }
	  .silver{
	  	background-color:#C0C0C0;
	  }
	  
	  .white{
		background-color:#fff;
	  }
	  .black{
		background-color:#000000;
		border:2px dashed #fff;
	  }
	  
	              .modalWindow{
width: 100%;
    height: 100%;
    position: absolute;
    z-index: 1500;
    background: white;
    opacity: 0.7;
}
    </style>
	<script type="text/javascript">
	
	function generateUUID(){
	    var d = new Date().getTime();
	    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
	        var r = (d + Math.random()*16)%16 | 0;
	        d = Math.floor(d/16);
	        return (c=='x' ? r : (r&0x7|0x8)).toString(16);
	    });
	    return uuid;
	};
	
	function showModal(){
		  $("body").append('<div class="modalWindow"/>');
		}

		function hideModal(){
		 $(".modalWindow").remove();

		}
	
var ctx, color = "#000";	

$(document).ready(function () {
	
	// setup a new canvas for drawing wait for device init
    setTimeout(function(){
	   newCanvas();
    }, 1000);
	
	// prevent footer to toggle on touch
	$("[data-role=footer]").fixedtoolbar({ tapToggle: false });
	
	// reset palette selection (css) and select the clicked color for canvas strokeStyle
	$(".tool").click(function(){
		$(".tool").css("border-color", "#777");
		$(".tool").css("border-style", "solid");
		$(this).css("border-color", "#fff");
		$(this).css("border-style", "dashed");
		
	});
	
	$(".small-pen").click(function(){
		 $.fn.draw=$.fn.smallPenDraw;
		 console.info("set tool small pen");
		 ctx.beginPath();
	});
	
	$(".medium-pen").click(function(){
		 $.fn.draw=$.fn.mediumPenDraw;
		 console.info("set tool medium pen");
		 ctx.beginPath();
	});
	$(".eraser").click(function(){
		$.fn.draw=$.fn.eraserDraw;
		 console.info("set tool eraser");
		 ctx.beginPath();
	});
	
	/*******
	* choose color
	*/
	$(".color-card").click(function(){
		color = $(this).css("background-color");
		console.info("choose color:"+color);
		$(".color-choice").css("background-color",color);
		
		$("#colorPalette").popup("close");
	});
    
	// link the new button with newCanvas() function
	$("#draw").click(function() {
		newCanvas();
	});
	
	// link the complete button with completeDraw() function
	$("#complete").click(function(){
		// show dialog ask answer
		$(document).simpledialog2({
		    mode: 'button',
		    headerText: '答案',
		    headerClose: true,
		    buttonPrompt: '请輸入正确答案',
		    buttonInput: true,
		    buttons : {
		      'OK': {
		        click: function () { 
		          //
		          
		          var answer=$.mobile.sdLastInput;
		          
		          console.debug("get answer:"+answer);
		          
		          var canvas= document.getElementById("canvas");
		          
		          if (canvas.toBlob) {
		        	    canvas.toBlob(
		        	        function (imageBlob) {
		        	            console.debug(imageBlob);
		        	            
		        	            var s3Uploader = new S3Upload({
		        	            	s3_object_name:generateUUID()+".png",
		        	            	onProgress: function(percent, message) {
		        	                    console.debug('Upload progress: ' + percent + '% ' + message);
		        	                },
		        	                onFinishS3Put: function(public_url) {
		        	                	
		        	                   console.debug('Upload completed. Uploaded to: '+ public_url);
		        	                   public_url=public_url.replace("https://","http://");
		        	                   // post question
		        	                   
		        	                   var question = {
		        	                		   imageUrl:public_url,
		        	                		   answer:answer
		        	                   };
		        	                   
		        	                   $.post("/data/question",question,sucess=function(msg){
		        	                	   console.debug(msg);
		        	                	   
		        	                	   $.mobile.loading("hide");
		        	                	   hideModal();
			        	                   
			        	                   $("#uploadSuccessPop").popup("open");
			        	                   window.setTimeout(function(){
			        	                   	$("#uploadSuccessPop").popup("close");
			        	                   
		        	                	   	window.location="/page/question/"+msg._id+".html";
			        	                   },1200);
		        	                   },"json");
		        	                },
		        	                onError: function(status) {
		        	                   console.debug('Upload error: ' + status);
		        	                   $.mobile.loading("hide");
		        	                   
		        	                   $("#uploadFailedPop").popup("open");
		        	                   $("#uploadFailedPop").delay(1500).popup("close");
		        	                }
		        	            });
		        	            $.mobile.loading('show',{
		        	            	text:"上传图片...",
		        	            	textVisible: true,
		        	            	theme:"b",
		        	            	html:""
		        	            });
		        	            showModal();
		        	            var results = s3Uploader.handleFileBlob(imageBlob);
		        	            console.debug(results);
		        	        },
		        	        'image/png'
		        	    );
		        	}
		        }
		      },
		    }
		  })
	});
	
	
	
});

// function to setup a new canvas for drawing
function newCanvas(){
	//define and resize canvas
    $("#content").height($(window).height()-90);
    var canvas = '<canvas id="canvas" width="'+$(window).width()+'" height="'+($(window).height()-90)+'"></canvas>';
	$("#content").html(canvas);
    
    // setup canvas
	ctx=document.getElementById("canvas").getContext("2d");
	
	// set init value
	
	// choose smal pen by default
	$(".small-pen").trigger("click");
	// choose color black by default
	$(".black").trigger("click");
	
	// setup to trigger drawing on mouse or touch
	$("#canvas").drawTouch();
    $("#canvas").drawPointer();
	$("#canvas").drawMouse();
}

// prototype to	start drawing on touch using canvas moveTo and lineTo
$.fn.drawTouch = function() {
	var start = function(e) {
        e = e.originalEvent;
		ctx.beginPath();
		x = e.changedTouches[0].pageX;
		y = e.changedTouches[0].pageY-44;
		ctx.moveTo(x,y);
	};
	var move = function(e) {
		e.preventDefault();
        e = e.originalEvent;
		x = e.changedTouches[0].pageX;
		y = e.changedTouches[0].pageY-44;
		$("#canvas").draw(x,y);
	};
	$(this).on("touchstart", start);
	$(this).on("touchmove", move);	
}; 
    
// prototype to	start drawing on pointer(microsoft ie) using canvas moveTo and lineTo
$.fn.drawPointer = function() {
	var start = function(e) {
        e = e.originalEvent;
		ctx.beginPath();
		x = e.pageX;
		y = e.pageY-44;
		ctx.moveTo(x,y);
	};
	var move = function(e) {
		e.preventDefault();
        e = e.originalEvent;
		x = e.pageX;
		y = e.pageY-44;
		$("#canvas").draw(x,y);
    };
	$(this).on("MSPointerDown", start);
	$(this).on("MSPointerMove", move);
};        

// prototype to	start drawing on mouse using canvas moveTo and lineTo
$.fn.drawMouse = function() {
	var clicked = 0;
	var start = function(e) {
		clicked = 1;
		ctx.beginPath();
		x = e.pageX;
		y = e.pageY-44;
		ctx.moveTo(x,y);
	};
	var move = function(e) {
		if(clicked){
			x = e.pageX;
			y = e.pageY-44;
			$("#canvas").draw(x,y);
		}
	};
	var stop = function(e) {
		clicked = 0;
	};
	$(this).on("mousedown", start);
	$(this).on("mousemove", move);
	$(window).on("mouseup", stop);
};

/*********
 * draw functions
 */

 
 $.fn.smallPenDraw=function(x,y){
	 ctx.lineWidth = 1;	
	 ctx.strokeStyle=color;
	 ctx.lineTo(x,y);
	 ctx.stroke();
}

 $.fn.mediumPenDraw=function(x,y){
	 ctx.lineWidth = 5;	
	 ctx.strokeStyle=color;
	 ctx.lineTo(x,y);
	 ctx.stroke();
}
 
 $.fn.eraserDraw=function(x,y){
	 ctx.lineWidth = 8;	
	 ctx.strokeStyle="#FFFFFF";
	 ctx.lineTo(x,y);
	 ctx.stroke();
}

$.fn.crayonDraw=function(x,y){
	var v = 2;//this.subtract(this._latest);//当前点与下一个点的距离的横纵坐标 
    var s = Math.ceil(5 / 2);		//算出粒子的单位长度
    var stepNum = Math.floor(v.length() / s) + 1;	//算出步长  v.length()为斜线长度
    v.normalize(s);//当前点与下一个点的
	
	
	
    var sep = 1.5; // 分割数  控制画笔的浓密程度  关键所在
	//粒子的大小 根据画笔描绘的速度（画笔的停留时间）进行调整
    var dotSize = sep * Math.min(10 / 1 * 3, 1);
    var dotNum = Math.ceil(this.size * sep);
	/**debug调试
    log(stepNum);
	log(dotNum);
	log(dotSize);
	**/
	
    var range = this.size / 2;
    var i, j, p, r, c, x, y;
    
    for (i = 0; i < dotNum; i++) {
		for (j = 0; j < stepNum; j++) {
			p = this._latest.add(v.scale(j));
			r = random(range);
			c = random(Math.PI * 2);
			w = random(dotSize, dotSize / 2);
			h = random(dotSize, dotSize / 2);
			x = p.x + r * Math.sin(c) - w / 2;
			y = p.y + r * Math.cos(c) - h / 2;
			ctx.rect(x, y, w, h);
			//ctx.arc(x,y,w,0,Math.PI * 2,true);
		}
	}
    
    ctx.fill();
    ctx.restore();
}

 $.fn.draw=$.fn.penDraw;

	</script>
</head>
<body>
<div data-role="page" id="page1">
    <div data-theme="a" data-role="header">
        <h3>我画你猜</h3>
		<a id="draw" data-role="button" data-theme="b" class="ui-btn-left">画</a>
		<a id="complete" data-role="button" data-theme="b" class="ui-btn-right">完成</a>
    </div>
    <div id="content"><p style="text-align:center">Loading Canvas...</p></div>
    <div data-theme="b" data-role="footer" data-position="fixed">
		<div class="tool-case">
			<div class="tool-box">
				<div class="tool small-pen">
					<image src="/image/pen-small.png" height="36px"/>
				</div>
			</div>	
			<div class="tool-box">
				<div class="tool medium-pen">
					<image src="/image/medium-pen.png" height="36px"/>
				</div>
			</div>
			<div class="tool-box">
				<div class="tool eraser">
					<image src="/image/eraser.png" height="36px"/>
				</div>
			</div>
			<div class="tool-box">
			
				<div class="color-palette">
				<a href="#colorPalette" data-rel="popup" data-transition="slideup">
					<div class="color-choice" style="background-color:black;width:36px;height:36px;"></div>
				</a>
				<div data-role="popup" id="colorPalette" data-theme="b" class="ui-grid-b">
						<div class="ui-block-a">
						<div class="color-card red" data-rel="back"></div>
						</div>
						<div class="ui-block-b">
						<div class="color-card blue"></div>
						</div>
						<div class="ui-block-c">
						<div class="color-card green"></div>
						</div>
						<div class="ui-block-a">
						<div class="color-card yellow"></div>
						</div>
						<div class="ui-block-b">
						<div class="color-card aqua"></div>
						</div>
						<div class="ui-block-c">
						<div class="color-card fuchsia"></div>
						</div>
						<div class="ui-block-a">
						<div class="color-card silver"></div>
						</div>
						<div class="ui-block-b">
						<div class="color-card black"></div>
					</div>
				</div>
				</div>
			
			</div>
		</div>
    </div>
    <div data-role="popup" id="uploadSuccessPop">
		<p>上传图片成功。<p>
	</div>
	<div data-role="popup" id="uploadFailedPop">
		<p>上传图片失败！<p>
	</div>
</div> 
</body>
</html>
